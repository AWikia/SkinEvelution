// MediaWiki
	var mediawiki = document.querySelector("html:not(.ivilution-loaded) body.mediawiki");

/* Mobile Only CSS */
if (navigator.userAgent.match("Mobile")) {
document.querySelector("html").className += " phone"
}

/* Local Storage */
function getKey(key) {
var str = window.localStorage,
    result = str.getItem('-evelution-preference-'+key);
if (!result) {
   return '-1';
}
return result;
}

function insertKey(key,value) {
	window.localStorage.setItem('-evelution-preference-' + key, '' + value);
}

function getParams() {
	if (window.location.search != "") {
		var params = window.location.search.split("?")[1].split("&");
    } else {
		var params = []
    }
	return params
}


/* Dropdowns */
// Calls the function on all toggles
function DropDownUpdate() {
	var dropdowns = document.querySelectorAll(".cpe-dropdown");
	dropdowns.forEach(function(x) {
		x.setAttribute('tabindex',-1); // Add the CPE button class
	});


/* Select Inputs */
	var select_items = document.querySelectorAll(".cpe-dropdown.cpe-select .cpe-dropdown__content .cpe-list li:not(.cpe-dropdown-level-2)");
	select_items.forEach(function(y) {
		y.setAttribute('onclick','UpdateSelectValue()')
		y.addEventListener('click', (function(e) {
						e.preventDefault();
						var selected = this;


		var x = document.querySelector(".cpe-dropdown.cpe-select:focus-within .cpe-dropdown__content .cpe-list li.selected");
		if (x) {
			x.classList.remove("selected");
		}
//		this.classList.add("selected");


						var value = selected.getAttribute("value");
						document.querySelector(' .cpe-dropdown.cpe-select:focus-within')
						.addEventListener('click',(function() {
									if (selected != undefined) {
										var content = selected.innerText;
										document.querySelector('.cpe-select:focus-within .cpe-select__value').setAttribute("value", value);
										document.querySelector('.cpe-select:focus-within .cpe-select__value').innerHTML= content;
										selected = undefined;
//										TestDynamicTheme(); // Change
									}
								}));
        }) );
	});

					
}


/* Range Inputs and Selects */
function UpdateSelectValue() { // Handles Blurring
		setTimeout(
		(function() { document.querySelector(' .cpe-dropdown.cpe-select:focus-within').blur(); 	document.querySelector('.focus-overlay').focus(); } )
	,0)
}


function UpdateRange() {
	var ranges = document.querySelectorAll('input[type="range"]');
	ranges.forEach(function(x) {
		x.style.setProperty("--range-percent",  (( ((x.value) - x.getAttribute('min') ) * 100) / (x.getAttribute('max') - x.getAttribute('min')) ) + '%'  );
	});

	var progresses = document.querySelectorAll('progress');
	progresses.forEach(function(x) {
		x.style.setProperty("--range-percent",  (( ((x.getAttribute('value')) - 0 ) * 100) / (x.getAttribute('max') - 0) ) + '%'  );
	});

}

function UpdateRangeInputs() {
	UpdateRange();

	var ranges2 = document.querySelectorAll('input[type="range"]');
	ranges2.forEach(function(x) {
		x.addEventListener("input", function(e) { UpdateRange(); });
	});

}

/* Enable New Global Navigation - No exception for now */
(function () {
	AliasFandomComponents();
	if (getKey('content-full') === '-1') {
		insertKey('content-full', 'false' );
	}
	if (getKey('right-rail-full') === '-1') {
		insertKey('right-rail-full', 'true' );
	}
	if (getKey('left-nav-full') === '-1') {
		insertKey('left-nav-full', 'true' );
	}
	var content_full = getKey('content-full')
	var right_rail_full = getKey('right-rail-full');
	var left_nav_full = getKey('left-nav-full');
    getParams().forEach(function (param) {
        var key = param.split("=")[0];
        var value = param.split("=")[1];

        switch (key) {
            case 'fullwidth':
				content_full = value;
				console.info('Article width settings overriden')
                break;
            case 'hiderail':
				if (value === 'true') {
					right_rail_full = 'false';
				} else {
					right_rail_full = 'true';
				}
				console.info('Pane visibility settings overriden')
                break;
            case 'hiderightrail':
				if (value === 'true') {
					right_rail_full = 'false';
				} else {
					right_rail_full = 'true';
				}
				console.info('Right pane visibility settings overriden')
                break;
            case 'hideleftnav':
				if (value === 'true') {
					left_nav_full = 'false';
				} else {
					left_nav_full = 'true';
				}
				console.info('Left navigation for large screens visibility settings overriden')
                break;

        }
    });
    if (content_full === 'true') {
		document.querySelector(' body ').classList.add('is-wide');
	}
    if (right_rail_full === 'true') {
		document.querySelector(' body ').classList.add('has-right-rail');
	}
    if (left_nav_full === 'true') {
		document.querySelector(' body ').classList.add('has-left-nav');
	}

	UpdateRangeInputs();
	DropDownUpdate();
	var y = document.querySelector('.evelution-taskbar .cpe-dropdown.search:not(:focus) .link');
	if (y) {
		y.addEventListener('click', (function(e) {
						e.preventDefault();
						var y2 = document.querySelector('.evelution-taskbar .cpe-dropdown.search input.taskbar-search');
						y2.focus();
        }) );
	}

})();

/* Aliases all components with the .wds prefix to the ones from .cpe ones */
function AliasFandomComponents() {

	var highlightedItems = document.querySelectorAll(":not(svg)[class*='wds-'], [class*='cpe-is-'], [class*='cpe-has-']");

	while (document.querySelectorAll(':not(svg)[class*="wds-"], [class*="cpe-is-"], [class*="cpe-has-"]').length > 0) {
		highlightedItems.forEach(function(x) {
			x.className = x.className.replace("wds-is-", "is-");
			x.className = x.className.replace("wds-has-", "has-");
			x.className = x.className.replace("cpe-is-", "is-");
			x.className = x.className.replace("cpe-has-", "has-");
			x.className = x.className.replace("wds-midlight-aqua", "cpe-midlight-color");
			x.className = x.className.replace("wds-", "cpe-");
		});
	}


}



/* Banners */
function RemoveBanner() {
		var banner= document.querySelector('#floatingbanner .cpe-banner-notification:focus-within');
		banner.classList.add("is-transparent")
		setTimeout(
		(function () {
			banner.remove();			
			if (!(document.querySelectorAll("#floatingbanner .cpe-banner-notification").length)) {
				document.querySelector('#floatingbanner').remove();
			}
			document.querySelector('.focus-overlay').focus();
		}),405);
	

}

function RemoveBanners() {
	var banners = document.querySelectorAll('#floatingbanner .cpe-banner-notification');
	banners.forEach(function(banner) {
		banner.classList.add("is-transparent")
		setTimeout(
		(function () {
			banner.remove();			
			if (!(document.querySelectorAll("#floatingbanner .cpe-banner-notification").length)) {
				document.querySelector('#floatingbanner').remove();
			}
			document.querySelector('.focus-overlay').focus();
		}),405);

	});

}

function AddFloatingBanner(content='Sample Content',kind='message',extraclass='') {
	if (kind === 'alert') {
		var icon = 'report'
	} else if (kind === 'pause') {
		var icon = 'pause'
	} else if (kind === 'warning') {
		var icon = 'report_problem'
	} else if (kind === 'success') {
		var icon = 'done'
	} else if (kind === 'progress') {
		var icon = 'pending'
	} else {
		var icon = 'info'
	}
	var nogap = false;
	if (!(document.querySelector(".top-gap #floatingbanner"))) {
		var nogap = true;
		document.querySelector(".top-gap").insertAdjacentHTML('afterbegin', 
			  '<div class="cpe-banner-notification__container" id="floatingbanner" style="pointer-events:none;">' +
			  '<div style="display:flex; flex-flow:column;"><button style="pointer-events:auto; align-self:flex-end; margin-right:8.5px;" class="cpe-button" onclick="RemoveBanners()">Clear all</button></div>' +
			  '\n<div class="banners" style="pointer-events:auto;"></div></div>'
		);
	}

	document.querySelector(".top-gap #floatingbanner .banners").insertAdjacentHTML('beforeend', 
			'<div class=" cpe-banner-notification is-' + kind + '" id="' + extraclass  + '">' +
			  '<div class="cpe-banner-notification__icon">' +
				'<span class="cpe-icon cpe-icon-small material-icons">' +
					icon + 
				'</span>' +
			  '</div>' +
			  '<span class="cpe-banner-notification__text">' + content + '</span>' +
			  '<span tabindex="-1" onclick="RemoveBanner()" class="cpe-banner-notification__close">' +
				'<span class="cpe-icon cpe-icon-tiny cpe-icon-large material-icons">close</span>' +
			  '</span>' +
			'</div>' 
	);
	


}

/* File Downloader */
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define("FileSaver.js",function(){return saveAs})}

/* Save File */
 function saveFileAs(contents,fileType,fileName) {
    /** Allow for downloading a file to a disk.
        This relies the FileSaver.js library which exports saveAs()
        Two utility methods saveImageAs and saveXMLAs should be used first.
    */
    var blobIsSupported = false,
        fileExt,
        dialog;

    // fileType is a <kind>/<ext>;<charset> format.
    fileExt = fileType.split('/')[1].split(';')[0];
    // handle text/plain as a .txt file
    fileExt = '.' + (fileExt === 'plain' ? 'txt' : fileExt);

    function dataURItoBlob(text, mimeType) {
        var i,
            data = text,
            components = text.split(','),
            hasTypeStr = text.indexOf('data:') === 0;
        // Convert to binary data, in format Blob() can use.
        if (hasTypeStr && components[0].indexOf('base64') > -1) {
            text = atob(components[1]);
            data = new Uint8Array(text.length);
            i = text.length;
            while (i--) {
                data[i] = text.charCodeAt(i);
            }
        } else if (hasTypeStr) {
            // not base64 encoded
            text = text.replace(/^data:image\/.*?, */, '');
            data = new Uint8Array(text.length);
            i = text.length;
            while (i--) {
                data[i] = text.charCodeAt(i);
            }
        }
        return new Blob([data], {type: mimeType });
    }

    try {
        blobIsSupported = !!new Blob();
    } catch (e) {}

    if (blobIsSupported) {
        if (!(contents instanceof Blob)) {
            contents = dataURItoBlob(contents, fileType);
        }
        // download a file and delegate to FileSaver
        // false: Do not preprend a BOM to the file.
        saveAs(contents, fileName + fileExt, false);
    } else {
        prompt("Could not export" + fileName);
    }
 }
 
 /* Download Data */
function DownloadData(contents,filename,ext) {
eval("saveFileAs(contents,\'text/"+ext+";charset=utf-8\', filename)");
}


/* Evelution Specific JS */

(function () {

var amodule = document.querySelector(".evelution-rail-wrapper .activity-module.evelution-module")
if  (amodule)  {
	var amodule2 = document.querySelector(".evelution-rail-wrapper .activity-module.evelution-module .evelution-module-content")
	var oldc = amodule2.innerText;
	amodule2.innerHTML =  oldc ;
}


var imodule = document.querySelector(".evelution-rail-wrapper .info-module.evelution-module")
if  (imodule)  {
	var imodule2 = document.querySelector(".evelution-rail-wrapper .info-module.evelution-module .evelution-module-content")
	var oldc2 = imodule2.innerText;
	imodule2.innerHTML =  oldc2 ;
}


/* TMP Hack until best solution goes */
var titles = document.querySelectorAll(".namespace-with-title .firstHeading")
if  (titles) {
		titles.forEach(function(x) {
			var oldc3 = x.innerText;
			x.innerHTML =  oldc3 ;
		});
}



/* Only used in one place */
	var parser = document.querySelector('.raw-parser');
	if (parser) {
		var c = parser.innerText;
		parser.innerHTML=  c;
		parser.classList.remove('raw-parser')
		parser.classList.add('raw-parser-done');
	}
/* Avatar */
	var avatar = document.querySelector('.evelution-taskbar .mw-socialprofile-avatar');
	if (avatar) {
		avatar.classList.add('cpe-icon');
		avatar.classList.add('cpe-avatar');
	}

CheckCompat();
RemoveEmptyMenus();
AliasBoxes();

	/* DITTO */
	document.querySelector("body").addEventListener("mouseenter", ( function(e) { CheckTheme(); } ) );
	document.querySelector("body").addEventListener("mouseleave", ( function(e) { DropDownUpdate(); CheckTheme(); } ) );
	document.querySelector('html').classList.add('theming-loaded');
		

	/* END DITTO */

	var level = 1;

DetectGPU.getGPUTier().then(function(e) { level = (e.fps == undefined) ? 1 : (e.fps >= 60) ? 4 : (e.fps >= 55) ? 3 : (e.fps >= 5) ? 2 : 0;  document.querySelector('html').classList.add('gpu-level-' + level);});

})();

function CheckHardware(level) {
		if (level === 0) {
			document.querySelector('body').innerHTML='<style> *, :before, :after {all:initial!important;}*:not(html):not(body):not(.warn) {display:none!important;}</style><div class="warn">Unsupported Configuration</div>';
			console.error('Hardware requirements are not met and Evelution can\'t run. Please upgrade your hardware');
		} else if (level === 1) {
			AddFloatingBanner("Hardware Acceleration is not available and experience with Evelution on this browser will not be optimal.", "warning");
		}

}

function AliasBoxes() {
	{{#has-box-alias}}
		var error = document.querySelectorAll('.errorbox:not(.tux-nojs):not(.noconvert)');
		error.forEach(function(x) {
			AddFloatingBanner(x.innerHTML,'alert');
			x.remove();
		});
		var warn = document.querySelectorAll('.warningbox:not(.tux-nojs):not(.noconvert)');
		warn.forEach(function(x) {
			AddFloatingBanner(x.innerHTML,'warning');
			x.remove();
		});
		var success = document.querySelectorAll('.successbox:not(.tux-nojs):not(.noconvert)');
		success.forEach(function(x) {
			AddFloatingBanner(x.innerHTML,'success');
			x.remove();
		});
		var message = document.querySelectorAll('.messagebox:not(.tux-nojs):not(.noconvert)');
		message.forEach(function(x) {
			AddFloatingBanner(x.innerHTML,'messagebox');
			x.remove();
		});
	{{/has-box-alias}}
}


/* Check Compatibility */
function CheckCompat() {
	// Some old Fox Versions
	var ua_agent = navigator.userAgent

	if ( (ua_agent.match("Safari/")) && !( (ua_agent.match("Chrome/")) || (ua_agent.match("YNGT")) ) ) { // Safari
		window.oldBrowser = ua_agent.match(/Version\/(\d+)/)[1] < 14
	}

	if ( (ua_agent.match("Firefox/")) && !( (ua_agent.match("PaleMoon/")) ) ) { // Mozilla Firefox
		window.oldBrowser = ua_agent.match(/Firefox\/(\d+)/)[1] < 84
	}

	if ( (ua_agent.match("PaleMoon/")) ) { // Pale Moon
		window.oldBrowser = ua_agent.match(/PaleMoon\/(\d+)/)[1] < 29
	document.querySelector('html').classList.add('pale-moon')
	}


	if ( (ua_agent.match("Chrome/")) && !( (ua_agent.match("Edge/")) ) ) { // Google Chrome
		window.oldBrowser = ua_agent.match(/Chrome\/(\d+)/)[1] < 84
	}
	

	window.oldBrowser =( 
						(window.oldBrowser) ||						    // Old Chrome, Firefox, Safari and Pale Moon
						(ua_agent.match("Trident")) ||					// Internet Explorer 				
						(ua_agent.match("Presto")) || 					// Classic Opera
						(ua_agent.match("Tessera")) || 					// 4x4 Browser
						(ua_agent.match("MINERVOULA")) || 				// Older mInerva
						(ua_agent.match("Silk")) || 					// Amazon Silk
						(ua_agent.match("PLAYSTATION 3")) || 			// PS3 Browser
						(ua_agent.match("Nintendo DSi")) || 			// Nintendo DSi Browser
						(ua_agent.match("Nintendo 3DS")) || 			// Nintendo 3DS Browser
						(ua_agent.match("PLAYSTATION PORTABLE")) || 	// PSP Browser
						(ua_agent.match("Edge")) || 					// Classic Microsoft Edge
						(ua_agent.match("BlackBerry")) || 				// Blackberry Browser
						(ua_agent.match("IEMobile")) 					// Phone Internet Explorer
						)
	
	if (window.oldBrowser) {
		document.querySelector('body').innerHTML='<style> *, :before, :after {all:initial!important;}*:not(html):not(body):not(.warn) {display:none!important;}</style><div class="warn">Unsupported Configuration</div>';
		console.error('Browser requirements are not met and Evelution can\'t run. Please upgrade your browser to latest');
//		AddFloatingBanner("Browser requirements are not met and experience with Evelution on this browser will not be optimal.", "warning");
	}
	{{#is-outdated}}
	AddFloatingBanner("We're dropping support for this MediaWiki version soon. Please make sure to update MediaWiki as soon as possible so as to keep enjoying the latest Evelution improvements","warning")
	{{/is-outdated}}
}


function ResetSettings() {
	if (confirm("Are you sure you want to reset Evelution's settings to their defaults? This can't be undone.")) {
		insertKey('content-full', 'false' );
		insertKey('right-rail-full', 'true' );
		insertKey('theme-selected', 'A' );
		if ( ( window.matchMedia('(forced-colors: active)').matches ) ) {
			insertKey('visual-appearance-mode', 'contrast' );
		} else {
			insertKey('visual-appearance-mode', 'standard' );
		}
			insertKey('visual-appearance-style', 'standard' );
		insertKey('visual-color', 'standard' );
		insertKey('filter-active', 'standard' );
		insertKey('device-theme', 'light' );
		insertKey('color-style', 'standard' );
		insertKey('color-style-behavior', 'duo' );
		insertKey('color-hue', 0 );
		insertKey('color-sat', 100 );
		insertKey('contrast-mode', 'auto' );
		insertKey('accent-active', 'false' );
		if ( ( window.matchMedia('(forced-colors: active)').matches ) ) {
			insertKey('dcm-mode', 'classic' );
		} else {
			insertKey('dcm-mode', 'standard' );
		}
		AddFloatingBanner('Succesfully resetted Evelution\'s settings to their defaults. Page will now reload.','success');
		location.reload()
	}
}

/* Width Toggler */
function ToggleWidth() {
	if 	(document.querySelector(' body.is-wide ')) {
		document.querySelector(' body ').classList.remove('is-wide');
		insertKey('content-full', 'false');
	} else {
		document.querySelector(' body ').classList.add('is-wide');
		insertKey('content-full', 'true');
	}
}


function ToggleRail() {
	if 	(document.querySelector(' body.has-right-rail ')) {
		document.querySelector(' body ').classList.remove('has-right-rail');
		insertKey('right-rail-full', 'false' );
	} else {
		document.querySelector(' body ').classList.add('has-right-rail');
		insertKey('right-rail-full', 'true' );
	}
}

function ToggleNav() {
	if 	(document.querySelector(' body.has-left-nav ')) {
		document.querySelector(' body ').classList.remove('has-left-nav');
		insertKey('left-nav-full', 'false');
	} else {
		document.querySelector(' body ').classList.add('has-left-nav');
		insertKey('left-nav-full', 'true');
	}
}



function RemoveEmptyMenus() {
// Remove Miraheze elements
	var miraheze = document.querySelector("#footer-icons img[alt='Miraheze Wiki Hosting'], #footer-icons img[alt='Hosted by Miraheze'], #footer-icons img[alt='7 years of Miraheze!']")
	if (miraheze) { // Check if an image with the Miraheze Wiki hosting alt exists
		document.querySelector('html').classList.add('wikihost-miraheze')
	}
	var qqore = document.querySelector("#footer-icons img[alt='Q.Qore']")
	if (qqore) { // Check if an image with the Miraheze Wiki hosting alt exists
		document.querySelector('html').classList.add('wikihost-qqore')
	}
	document.querySelector('html').classList.remove("client-dark-mode");
	
	
// Remove duplicated Notices and Updates Dropdown

	var langmenu4N = document.querySelector(".evelution-taskbar.evelution-sidebar .link.notices-menu #pt-notifications-notice");
	var langmenu4bN = document.querySelector(".evelution-taskbar.evelution-sidebar .link.updates-menu #pt-notifications-alert");
		if (langmenu4N) {
			langmenu4N.remove();	
		}
		if (langmenu4bN) {
			langmenu4bN.remove();
		}


	if (! (document.querySelector(".evelution-article-actions .more-actions-menu .cpe-dropdown__content .cpe-list > li")) ) {
		var langmenu2 = document.querySelector(".evelution-article-actions .more-actions-menu");
		if (langmenu2) {
			langmenu2.remove();
		}
	}
	
	
	toc = document.querySelector(".toc#toc > ul");
	if (toc) {
		document.querySelector(".evelution-header .toc-module .evelution-module-content > .toc > .toc").innerHTML = toc.innerHTML
	} else {
		var toc2 = document.querySelector(".evelution-header .toc-module")
		if (toc2) {
			toc2.remove();
		}
	}


	
	if (! (document.querySelector(".evelution-article-actions #ca-edit")) ) {
		var elink = document.querySelector(".evelution-taskbar .link.edit");
		var elink2 = document.querySelector(".evelution-taskbar li.edit");
		if (elink) {
			elink.remove();
		}
		if (elink2) {
			elink2.remove();
		}

	}
	if (! (document.querySelector(".evelution-article-actions #ca-history")) ) {
		var hlink = document.querySelector(".evelution-taskbar .link.history");
		var hlink2 = document.querySelector(".evelution-taskbar li.history");
		if (hlink) {
			hlink.remove();
		}
		if (hlink2) {
			hlink2.remove();
		}

	}




}