/* Dropdowns */
// Function to be used on the first child of .cpe-dropdown container
function DropDown() {
$(' .cpe-dropdown')
        .click(function(e) {
            var $this = $(this);
			if ($this.hasClass('cpe-is-active')) {
            $this.removeClass('cpe-is-active');
		$(' .cpe-dropdown').off( "click" );			

 return;
			}
			e.preventDefault();
			$this.addClass('cpe-is-active');
		$(' .cpe-dropdown').off( "click" );			
        });
}

// Calls the function on all toggles
function DropDownUpdate() {
$('.cpe-dropdown > :first-child').off( "click" );			
$('.cpe-dropdown').off( "mouseleave" );	
// Process Menus		
$(".cpe-dropdown > :first-child")
					.click( function(e) { 
						e.preventDefault(); 
						DropDown(); 
					});
					
// Close dropdowns on mouse leave
$(' .cpe-dropdown')
.mouseleave(function() {
            $(this).removeClass('cpe-is-active');
        });

}

/* Select Inputs */
$(' .cpe-dropdown.cpe-select .cpe-dropdown__content .cpe-list li:not(.cpe-dropdown-level-2)')
.click(function(e) {
						e.preventDefault();
						var value = $(this).attr("value");
						$(' .cpe-dropdown.cpe-select')
						.click(function() {
									var content = $('.cpe-select.cpe-is-active .cpe-dropdown__content .cpe-list li:not(.cpe-dropdown-level-2):hover > a').html();
									$('.cpe-select.cpe-is-active .cpe-select__value').attr("value", value);
									$('.cpe-select.cpe-is-active .cpe-select__value').html(content);
									$(this).removeClass('cpe-is-active');
									$(' .cpe-dropdown.cpe-select').off( "click" );
								});
        });



/* Enable New Global Navigation - No exception for now */
window.MW18newnavblock=false;
(function () {
	AliasFandomComponents();
	$('body').mouseenter( function(e) { RearrangeDOM(); } );		
	$('body').mouseover( function(e) { RearrangeDOM(); } );		
	$('body').mouseout( function(e) { RearrangeDOM(); } );		
	if (getKey('content-full') === '-1') {
		insertKey('content-full', 'false' );
	}
	if (getKey('toolbar-full') === '-1') {
		insertKey('toolbar-full', 'true' );
	}
	if (getKey('nav-full') === '-1') {
		insertKey('nav-full', 'true' );
	}
	if (getKey('rail-full') === '-1') {
		insertKey('rail-full', 'true' );
	}
	$(' container > main').attr('wide', getKey('content-full') );
	$(' container > main').attr('toolbar', getKey('toolbar-full'));
	$(' container > main').attr('nav', getKey('nav-full'));
	$(' container > main').attr('rail', getKey('rail-full'));
	DropDownUpdate();
	if (window.MW18newnavblock === true) {
		return
	}
/*
	if ($("body.mpisto-2018").length || $("body.mpisto-discuss-2018").length) {
		document.querySelector('.mpisto-gnav[style]').className += " newnav";
		document.querySelector('.mpisto-gnav:not([style])').className += " newnav";
	}
*/
})();


/* Module Toggle */
function ToggleModule() {

		$('.mpisto-module')
				.click(function() {
						var $this = $(this);
						if ($this.hasClass("hidden-module")) {
							$this.removeClass("hidden-module");
						} else {
							$this.addClass("hidden-module");
						}

						$('.mpisto-module').off( "click" );


			});

}

/* Banners */
function RemoveBanner() {
$('#floatingbanner .cpe-banner-notification')
	.click(function() {
		var $this= $(this);
		$this.addClass("cpe-is-transparent")
		setTimeout(
		(function () {
			$this.remove();
			$('#floatingbanner .cpe-banner-notification').off( "click" );
	if (!($("#floatingbanner .cpe-banner-notification").length)) {
		$('#floatingbanner').remove();
	}
		}),405);
	}
	);
	

}

function AddFloatingBanner(content='Sample Content',kind='message',extraclass='') {
	if (kind === 'warning') {
		var icon = 'report_problem'
	} else if (kind === 'alert') {
		var icon = 'report'
	} else if (kind === 'success') {
		var icon = 'done'
	} else {
		var icon = 'info'
	}
	if (!($(".top-gap #floatingbanner").length)) {
		$('.top-gap').prepend ( 
			  '<div class="cpe-banner-notification__container" id="floatingbanner">' +
			  '\n</div>'
		);
	}

	$('.top-gap #floatingbanner').append ( 
			'<div class=" cpe-banner-notification cpe-' + kind + '" id="' + extraclass  + '">' +
			  '<div class="cpe-banner-notification__icon">' +
				'<span class="cpe-icon cpe-icon-small material-icons-outlined">' +
					icon + 
				'</span>' +
			  '</div>' +
			  '<span class="cpe-banner-notification__text">' + content + '</span>' +
			  '<svg onclick="RemoveBanner()" xmlns="http://www.w3.org/2000/svg" class="cpe-banner-notification__close cpe-icon cpe-icon-tiny">' +
				'<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#cpe-icons-cross-tiny" />' +
			  '</svg>' +
			'</div>' 
	);


}

/* Width Toggler */
function ToggleWidth() {
	if 	($(' container > main').attr('wide') == 'true') {
		$(' container > main').attr('wide', 'false');
	} else {
		$(' container > main').attr('wide', 'true');
	}
	insertKey('content-full', $(' container > main').attr('wide') );
}

function ToggleBar() {
	if 	($(' container > main').attr('toolbar') == 'true') {
		$(' container > main').attr('toolbar', 'false');
	} else {
		$(' container > main').attr('toolbar', 'true');
	}
	insertKey('toolbar-full', $(' container > main').attr('toolbar') );
}


function ToggleNav() {
	if 	($(' container > main').attr('nav') == 'true') {
		$(' container > main').attr('nav', 'false');
	} else {
		$(' container > main').attr('nav', 'true');
	}
	insertKey('nav-full', $(' container > main').attr('nav') );
}

function ToggleRail() {
	if 	($(' container > main').attr('rail') == 'true') {
		$(' container > main').attr('rail', 'false');
	} else {
		$(' container > main').attr('rail', 'true');
	}
	insertKey('rail-full', $(' container > main').attr('rail') );
}


/* Aliases all components with the .wds prefix to the ones from .cpe ones */
function AliasFandomComponents() {

	var highlightedItems = document.querySelectorAll(":not(svg)[class*='wds-']");

	while ($(':not(svg)[class*="wds-"]').length > 0) {
		highlightedItems.forEach(function(x) {
			x.className = x.className.replace("wds-midlight-aqua", "cpe-midlight-color");
			x.className = x.className.replace("wds-", "cpe-");
		});
	}


}


function RearrangeDOM() {
	if ($('body > .oo-ui-defaultOverlay, body > .mw-notification-area-overlay, body > .uls-menu, body > .ve-ui-overlay, body > .imeselector.imeselector-toggle, body > .mwe-popups, body > .mwe-popups-overlay').length) {
		var oouioverlays = document.querySelectorAll("body > .oo-ui-defaultOverlay, body > .mw-notification-area-overlay, body > .uls-menu, body > .ve-ui-overlay, body > .imeselector.imeselector-toggle, body > .mwe-popups, body > .mwe-popups-overlay");
		oouioverlays.forEach(function(x) {
			var data = $(x);
			data.detach();
			$('container').append(data);
		});

	}
}

/* Part of this Skin */
(function () {

if  ($(".mpisto-right-pane .activity-module.mpisto-module").length)  {
	var oldc = $('.mpisto-right-pane .activity-module.mpisto-module .mpisto-module-content').text();
	$('.mpisto-right-pane .activity-module.mpisto-module .mpisto-module-content').html( oldc );
}
if  ($(".mpisto-right-pane .info-module.mpisto-module").length)  {
	var oldc2 = $('.mpisto-right-pane .info-module.mpisto-module .mpisto-module-content').text();
	$('.mpisto-right-pane .info-module.mpisto-module .mpisto-module-content').html( oldc2 );
}


RemoveEmptyMenus();
initializeViews();
	$(".mpisto-global-sidebar.mpisto-personal-links .link.toggle-size")
						.click( function(e) { 
							e.preventDefault(); 
							ToggleWidth(); 
						});
	$(".mpisto-global-sidebar.full-toolbar .link.bar-switch, .mpisto-global-sidebar.col-toolbar .link.bar-switch")
						.click( function(e) { 
							e.preventDefault(); 
							ToggleBar(); 
						});

	$(".mpisto-sticky-header-container.full-nav .link.nav-switch, .mpisto-sticky-header-container.col-nav .link.nav-switch")
						.click( function(e) { 
							e.preventDefault(); 
							ToggleNav(); 
						});
	$(".mpisto-page-header .toggle-rail-button")
						.click( function(e) { 
							e.preventDefault(); 
							ToggleRail(); 
						});
	$(".mpisto-header-container .link.dark-mode, .mpisto-sticky-header-container .link.dark-mode")
						.click( function(e) { 
							e.preventDefault(); 
							ToggleMode(); 
						});

	$(".cpe-dropdown__content .cpe-list .ThemeA")
						.click( function(e) { 
							e.preventDefault(); 
							HCa(); 
						});
	$(".cpe-dropdown__content .cpe-list  .ThemeB")
						.click( function(e) { 
							e.preventDefault(); 
							HCb(); 
						});
	$(".cpe-dropdown__content .cpe-list  .ThemeC")
						.click( function(e) { 
							e.preventDefault(); 
							HCc(); 
						});
	$(".cpe-dropdown__content .cpe-list .ThemeD")
						.click( function(e) { 
							e.preventDefault(); 
							HCd(); 
						});

})();


function initializeViews() {
	$(".mpisto-page-header-contribution-buttons .actions > li > a").attr('class','cpe-button'); // Add the CPE button class
	$(".mpisto-page-header-contribution-buttons .views > li > a").attr('class','cpe-button'); // Add the CPE button class

	$(".mpisto-header-container .mobile-header .local-navigation .cpe-dropdown:first-child:not(:only-child) .cpe-dropdown__content").addClass('cpe-is-left-aligned'); // Add the CPE button class
	$(".mpisto-header-container .mobile-header .local-navigation .cpe-dropdown:last-child:not(:only-child) .cpe-dropdown__content").addClass('cpe-is-right-aligned'); // Add the CPE button class

/* Views */

	// Talk Pages
	$(".mpisto-page-header-contribution-buttons .views > li#ca-talk > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								chat_bubble_outlined' +
	'							</span>'
	);

	// Translation (Translate Extension)
	$(".mpisto-page-header-contribution-buttons .views > li#ca-translate > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								translate' +
	'							</span>'
	);


	// Mainspace, Projectspace
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-main > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-project > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								description' +
	'							</span>'
	);
	
	// Special Pages, MediaWiki, Extension, API
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-special > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-mediawiki > a , .mpisto-page-header-contribution-buttons .views > li#ca-nstab-extension > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-topic > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								settings' +
	'							</span>'
	);
	
	// Userspace
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-user > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								person' +
	'							</span>'
	);
	
	// Filespace
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-image > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								image' +
	'							</span>'
	);
	
	// Help
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-help > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								help_outline' +
	'							</span>'
	);
	
	// Templates, Modules
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-template > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-module > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								bookmark_border' +
	'							</span>'
	);
	
	// Categories
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-category > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								grid_view' +
	'							</span>'
	);
	
	// Manual
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-manual > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-tutorial > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								build' +
	'							</span>'
	);
	
	// Thread, Topic, Forum
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-thread > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-topic > a, .mpisto-page-header-contribution-buttons .views > li#ca-nstab-forum > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								question_answer' +
	'							</span>'
	);
	
	// Skin
	$(".mpisto-page-header-contribution-buttons .views > li#ca-nstab-skin > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								palette' +
	'							</span>'
	);


/* Actions */

	// View
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-view > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								description' +
	'							</span>'
	);
	
	// Edit
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-edit > a, .mpisto-page-header-contribution-buttons .actions > li#ca-ve-edit > a, .mpisto-page-header-contribution-buttons .actions > li#ca-create > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								edit' +
	'							</span>'
	);

	// Add section
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-addsection > a").html(
	'<span class="cpe-icon cpe-icon-small material-icons-outlined">' +
	'								add' +
	'							</span>'
	);

	
	// View Source
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-viewsource > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								lock' +
	'							</span>'
	);

	// Foreign View, Lanaguage Stats (Translate Extension)
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-view-foreign > a, .mpisto-page-header-contribution-buttons .actions > li#ca-lstats > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								flag' +
	'							</span>'
	);

	// History
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-history > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								history' +
	'							</span>'
	);

	// Group Statistics (Translate Extension)
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-mstats > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								trending_up' +
	'							</span>'
	);


	// Export
	$(".mpisto-page-header-contribution-buttons .actions > li#ca-export > a").prepend(
	'<span class="cpe-icon cpe-icon-small margined material-icons-outlined">' +
	'								file_download' +
	'							</span>'
	);


}

function RemoveEmptyMenus() {
// Remove the Language Dropdown, if no languages exist
	var langmenu = document.querySelector(".mpisto-global-navigation.mpisto-global-sidebar .language-menu");
	var langmenuM = document.querySelector(".mpisto-mobile-global-navigation.mpisto-global-sidebar .language-menu");

	if (! ($(".mpisto-global-navigation.mpisto-global-sidebar .language-menu .cpe-dropdown__content .cpe-list").length) ) {
		$(langmenu).remove();
		$(langmenuM).remove();
	}

	var langmenu3 = document.querySelector(".mpisto-global-navigation.mpisto-global-sidebar .variants-menu");
	var langmenu3M = document.querySelector(".mpisto-mobile-global-navigation.mpisto-global-sidebar .variants-menu");
	
	if (! ($(".mpisto-global-navigation.mpisto-global-sidebar .variants-menu .cpe-dropdown__content .cpe-list > li").length) ) {
		$(langmenu3).remove();
		$(langmenu3M).remove();
	}

	var langmenu4 = document.querySelector(".mpisto-global-navigation.mpisto-global-sidebar .notices-menu");
	var langmenu4M = document.querySelector(".mpisto-mobile-global-navigation.mpisto-global-sidebar .notices-menu");
	
	if (! ($("div:not([class])[style='position:absolute; top:-999999999999999px; left:0;'] .cpe-list.cpe-is-linked #pt-notifications-alert").length) ) {
		$(langmenu4).remove();
		$(langmenu4M).remove();
	}


	var langmenu2 = document.querySelector(".mpisto-page-header .more-actions-menu");

	if (! ($(".mpisto-page-header .more-actions-menu .cpe-dropdown__content .cpe-list > li").length) ) {
		$(langmenu2).remove();
	}



}

